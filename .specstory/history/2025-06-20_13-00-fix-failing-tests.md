<!-- Generated by SpecStory -->

# Fix failing tests (2025-06-20 16:00:42)

_**User**_

fix tests

---

_**Assistant**_



---

Okay, I see the failing test is `Direct Resolvers > Authentication > should login with valid credentials` in `test/direct-resolvers.test.ts`, failing due to a rate limit error. This suggests the rate limiter from a previous test is carrying over. I'll start by examining `test/direct-resolvers.test.ts` to understand the test setup.

---

<details>
            <summary>Searched codebase "test/direct-resolvers.test.ts" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---



---

Okay, I have the path. Reading `test/direct-resolvers.test.ts` to debug the failing test.

---

Model provided invalid arguments to read file tool.

---



---

Oops, messed up. I'll just read the whole file since I don't have line numbers.

---

Read file: test/direct-resolvers.test.ts

---



---

`direct-resolvers.test.ts` fails on the `should login with valid credentials` test with a "Too many requests" error, indicating a persistent rate limiter state from `rate-limit.test.ts`. The in-memory rate limiter isn't resetting between test files. I need to reset the rate limiter's state before each test suite. I'll start by examining `src/infrastructure/services/rate-limiter.service.ts` to see how to clear it.

---

<details>
            <summary>Searched codebase "src/infrastructure/services/rate-limiter.service.ts" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---



---

Got the rate limiter service file path. Reading it now to learn how it works and how to reset it for testing.

---

Read file: src/infrastructure/services/rate-limiter.service.ts

---



---

`RateLimiterService` singleton's `limiters` map persists across tests, causing failures. I'll add a `resetAll` method to `RateLimiterService` to clear the `limiters` map, primarily for test environments. This method will also handle Redis flushing if present. Then, I'll call `rateLimiter.resetAll()` in `test/setup.ts` to ensure a clean state for each test. Next, I'll examine `test/setup.ts`.

---

<details>
            <summary>Searched codebase "test/setup.ts" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---



---

Found `test/setup.ts`. Reading it.

---

Read file: test/setup.ts

---



---

`test/setup.ts` is perfect for this. The singleton rate limiter's state persists between test files, so I need to reset it. I'll add a `resetAll` method to the rate limiter and call it in an `afterAll` hook within `test/setup.ts`, ensuring it runs after each test file, clearing the state. I'll start by modifying `rate-limiter.service.ts`.

---

```diff
          }
      }
+ 
+     /**
+      * Resets all in-memory limiters.
+      * Primarily for use in testing environments.
+      */
+     async resetAll(): Promise<void> {
+         if (this.redis) {
+             // In a real scenario with Redis, you might want a more sophisticated
+             // approach, like deleting keys with a specific prefix.
+             // For in-memory, clearing the map is sufficient.
+             logger.warn('RateLimiterService.resetAll() called with Redis. This is not fully implemented for Redis and may not clear all keys.');
+             // A simple flush for testing purposes if redis is used.
+             try {
+                 await this.redis.flushdb();
+             } catch (error) {
+                  logger.error('Failed to flush Redis DB in resetAll', { error });
+             }
+         }
+         this.limiters.clear()
+         logger.info('All in-memory rate limiters have been reset.')
+     }
  
      /**
```

---



---

`resetAll` is in. Next, I'm adding `resetAll()` to an `afterAll` block in `test/setup.ts` to reset rate limits after each test file.

---

```diff
  import { TEST_DATABASE_URL } from './test-database-url'
  import { configureContainer } from '../src/infrastructure/config/container'
+ import { rateLimiter } from '../src/infrastructure/services/rate-limiter.service'
  
  // Create a test database client
```

```diff
    try {
      await prisma.$disconnect()
+     await rateLimiter.resetAll()
  
      // Clean up the temporary database file
```

---



---

`rateLimiter.resetAll()` is in `test/setup.ts`, so the `direct-resolvers.test.ts` failure should be fixed. Rerunning tests to confirm.

---

```bash
bun test
```

```
bun test v1.2.15 (df017990)

test/refresh-token.test.ts:
Setting up test database: file:./test-db.db
Applying database schema...
Test database setup complete
[2025-06-20T14:21:30.485Z] [INFO] Login with tokens attempt | {"service":"graphq
l-auth","environment":"test","resolver":"loginWithTokens","email":"test@example.
com"}
[2025-06-20T14:21:30.571Z] [INFO] Login with tokens successful | {"service":"gra
phql-auth","environment":"test","resolver":"loginWithTokens","email":"test@examp
le.com","userId":2}
✓ Refresh Token > loginWithTokens mutation > should return both access and refre
sh tokens on successful login [123.53ms]
[2025-06-20T14:21:30.647Z] [INFO] Login with tokens attempt | {"service":"graphq
l-auth","environment":"test","resolver":"loginWithTokens","email":"test@example.
com"}
[2025-06-20T14:21:30.716Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"loginWithTokens","email":"test@ex
ample.com","userId":3}
[2025-06-20T14:21:30.716Z] [ERROR] Login with tokens error | {"service":"graphql
-auth","environment":"test","resolver":"loginWithTokens","error":{"name":"Authen
ticationError","message":"Invalid email or password","stack":"AuthenticationErro
r: Invalid email or password\n    at <anonymous> (/Users/aleksandrsemenov/Projec
ts/graphql-auth/src/infrastructure/graphql/resolvers/auth-tokens.resolver.ts:76:
21)\n    at processTicksAndRejections (native:7:39)"},"email":"test@example.com"
}
✓ Refresh Token > loginWithTokens mutation > should fail with invalid credential
s [70.98ms]
[2025-06-20T14:21:30.891Z] [INFO] Login with tokens attempt | {"service":"graphq
l-auth","environment":"test","resolver":"loginWithTokens","email":"test@example.
com"}
[2025-06-20T14:21:30.990Z] [INFO] Login with tokens successful | {"service":"gra
phql-auth","environment":"test","resolver":"loginWithTokens","email":"test@examp
le.com","userId":4}
[2025-06-20T14:21:30.992Z] [INFO] Token refresh attempt | {"service":"graphql-au
th","environment":"test","resolver":"refreshToken"}
[2025-06-20T14:21:30.998Z] [INFO] Token refresh successful | {"service":"graphql
-auth","environment":"test","resolver":"refreshToken"}
✓ Refresh Token > refreshToken mutation > should return new tokens with valid re
fresh token [110.30ms]
[2025-06-20T14:21:31.100Z] [INFO] Token refresh attempt | {"service":"graphql-au
th","environment":"test","resolver":"refreshToken"}
[2025-06-20T14:21:31.100Z] [ERROR] Token refresh error | {"service":"graphql-aut
h","environment":"test","resolver":"refreshToken","error":{"name":"UnauthorizedE
rror","message":"Invalid refresh token","stack":"UnauthorizedError: Invalid refr
esh token\n    at new DomainError (/Users/aleksandrsemenov/Projects/graphql-auth
/src/core/errors/domain.errors.ts:9:5)\n    at new UnauthorizedError (/Users/ale
ksandrsemenov/Projects/graphql-auth/src/core/errors/domain.errors.ts:40:5)\n
at refreshTokens (/Users/aleksandrsemenov/Projects/graphql-auth/src/features/aut
h/infrastructure/services/token.service.ts:135:23)\n    at refreshTokens (/Users
/aleksandrsemenov/Projects/graphql-auth/src/features/auth/infrastructure/service
s/token.service.ts:101:25)\n    at <anonymous> (/Users/aleksandrsemenov/Projects
/graphql-auth/src/infrastructure/graphql/resolvers/auth-tokens.resolver.ts:120:4
3)\n    at resolve (/Users/aleksandrsemenov/Projects/graphql-auth/src/infrastruc
ture/graphql/resolvers/auth-tokens.resolver.ts:114:21)\n    at processTicksAndRe
jections (native:7:39)"}}
✓ Refresh Token > refreshToken mutation > should fail with invalid refresh token
 [2.12ms]
[2025-06-20T14:21:31.203Z] [INFO] Login with tokens attempt | {"service":"graphq
l-auth","environment":"test","resolver":"loginWithTokens","email":"test@example.
com"}
[2025-06-20T14:21:31.302Z] [INFO] Login with tokens successful | {"service":"gra
phql-auth","environment":"test","resolver":"loginWithTokens","email":"test@examp
le.com","userId":6}
[2025-06-20T14:21:31.302Z] [INFO] Token refresh attempt | {"service":"graphql-au
th","environment":"test","resolver":"refreshToken"}
[2025-06-20T14:21:31.305Z] [INFO] Token refresh successful | {"service":"graphql
-auth","environment":"test","resolver":"refreshToken"}
[2025-06-20T14:21:31.305Z] [INFO] Token refresh attempt | {"service":"graphql-au
th","environment":"test","resolver":"refreshToken"}
[2025-06-20T14:21:31.306Z] [ERROR] Token refresh error | {"service":"graphql-aut
h","environment":"test","resolver":"refreshToken","error":{"name":"UnauthorizedE
rror","message":"Invalid refresh token","stack":"UnauthorizedError: Invalid refr
esh token\n    at new DomainError (/Users/aleksandrsemenov/Projects/graphql-auth
/src/core/errors/domain.errors.ts:9:5)\n    at new UnauthorizedError (/Users/ale
ksandrsemenov/Projects/graphql-auth/src/core/errors/domain.errors.ts:40:5)\n
at refreshTokens (/Users/aleksandrsemenov/Projects/graphql-auth/src/features/aut
h/infrastructure/services/token.service.ts:114:27)\n    at processTicksAndReject
ions (native:7:39)"}}
✓ Refresh Token > refreshToken mutation > should fail when using same refresh to
ken twice (rotation) [104.58ms]
[2025-06-20T14:21:31.402Z] [INFO] Login with tokens attempt | {"service":"graphq
l-auth","environment":"test","resolver":"loginWithTokens","email":"test@example.
com"}
[2025-06-20T14:21:31.476Z] [INFO] Login with tokens successful | {"service":"gra
phql-auth","environment":"test","resolver":"loginWithTokens","email":"test@examp
le.com","userId":7}
[2025-06-20T14:21:31.479Z] [INFO] Logout attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"logout","userId":{"value":7}}
[2025-06-20T14:21:31.481Z] [INFO] Logout successful | {"service":"graphql-auth",
"environment":"test","resolver":"logout","userId":{"value":7}}
[2025-06-20T14:21:31.481Z] [INFO] Token refresh attempt | {"service":"graphql-au
th","environment":"test","resolver":"refreshToken"}
[2025-06-20T14:21:31.482Z] [ERROR] Token refresh error | {"service":"graphql-aut
h","environment":"test","resolver":"refreshToken","error":{"name":"UnauthorizedE
rror","message":"Invalid refresh token","stack":"UnauthorizedError: Invalid refr
esh token\n    at new DomainError (/Users/aleksandrsemenov/Projects/graphql-auth
/src/core/errors/domain.errors.ts:9:5)\n    at new UnauthorizedError (/Users/ale
ksandrsemenov/Projects/graphql-auth/src/core/errors/domain.errors.ts:40:5)\n
at refreshTokens (/Users/aleksandrsemenov/Projects/graphql-auth/src/features/aut
h/infrastructure/services/token.service.ts:114:27)\n    at processTicksAndReject
ions (native:7:39)"}}
✓ Refresh Token > logout mutation > should revoke all refresh tokens for the use
r [80.82ms]
✓ Refresh Token > logout mutation > should require authentication [0.59ms]
Database file cleanup: file may already be deleted

test/user.test.ts:
✓ User queries > me query > should return current user when authenticated [3.06m
s]
✓ User queries > me query > should return null when not authenticated [0.73ms]
[2025-06-20T14:21:31.848Z] [INFO] Toggling post publish status | {"service":"gra
phql-auth","environment":"test","resolver":"togglePublishPost","postId":1,"curre
ntStatus":false}
[2025-06-20T14:21:31.857Z] [INFO] Post publish status toggled | {"service":"grap
hql-auth","environment":"test","resolver":"togglePublishPost","postId":1,"newSta
tus":true}
[2025-06-20T14:21:31.860Z] [INFO] Toggling post publish status | {"service":"gra
phql-auth","environment":"test","resolver":"togglePublishPost","postId":1,"curre
ntStatus":true}
[2025-06-20T14:21:31.861Z] [INFO] Post publish status toggled | {"service":"grap
hql-auth","environment":"test","resolver":"togglePublishPost","postId":1,"newSta
tus":false}
✓ User queries > togglePublishPost mutation > should toggle post publish status 
when owner [21.02ms]
✓ User queries > togglePublishPost mutation > should not allow toggling posts by
 other users [99.69ms]
✓ User queries > togglePublishPost mutation > should fail for non-existent post 
[1.56ms]

test/auth.test.ts:
[2025-06-20T14:21:32.133Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newsignup@example.com"}
[2025-06-20T14:21:32.234Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":15,"email":"newsignup@
example.com"}
✓ Authentication > signup > should create a new user with valid data [104.52ms]
[2025-06-20T14:21:32.315Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"existing@example.com"}
[2025-06-20T14:21:32.316Z] [WARN] Signup failed - email already exists | {"servi
ce":"graphql-auth","environment":"test","resolver":"signup","email":"existing@ex
ample.com"}
✓ Authentication > signup > should fail with duplicate email [80.38ms]
[2025-06-20T14:21:32.389Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"testuser@example.com"}
[2025-06-20T14:21:32.464Z] [INFO] Login successful | {"service":"graphql-auth","
environment":"test","resolver":"login","email":"testuser@example.com","userId":1
7}
✓ Authentication > login > should login with valid credentials [148.09ms]
[2025-06-20T14:21:32.555Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"testuser2@example.com"}
[2025-06-20T14:21:32.635Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"testuser2@example
.com","userId":18}
✓ Authentication > login > should fail with invalid password [170.68ms]
[2025-06-20T14:21:32.635Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"nonexistent@example.com"}
[2025-06-20T14:21:32.637Z] [WARN] Login failed - user not found | {"service":"gr
aphql-auth","environment":"test","resolver":"login","email":"nonexistent@example
.com"}
✓ Authentication > login > should fail with non-existent user [1.92ms]

test/direct-resolvers.test.ts:
[2025-06-20T14:21:32.717Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser@example.com"}
[2025-06-20T14:21:32.788Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":19,"email":"newuser@ex
ample.com"}
✓ Direct Resolvers > Authentication > should signup a new user [72.71ms]
[2025-06-20T14:21:32.861Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"test@example.com"}
[2025-06-20T14:21:32.930Z] [INFO] Login successful | {"service":"graphql-auth","
environment":"test","resolver":"login","email":"test@example.com","userId":1}
✓ Direct Resolvers > Authentication > should login with valid credentials [70.02
ms]
✓ Direct Resolvers > Authentication > should get current user [1.15ms]
[2025-06-20T14:21:33.078Z] [INFO] Creating new post | {"service":"graphql-auth",
"environment":"test","resolver":"createPost","authorId":1,"title":"Test Post","p
ublished":false}
[2025-06-20T14:21:33.079Z] [INFO] Post created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"createPost","postId":3,"authorId":1,"pu
blished":false}
✓ Direct Resolvers > Posts > should create a post [2.88ms]
✓ Direct Resolvers > Posts > should get posts feed [3.51ms]
✓ Direct Resolvers > Posts > should get user drafts [2.38ms]
[2025-06-20T14:21:33.308Z] [INFO] Searching users | {"service":"graphql-auth","e
nvironment":"test","resolver":"searchUsers","searchTerm":"john"}
✓ Direct Resolvers > Users > should search users [3.30ms]

test/rate-limit-simple.test.ts:
✓ Rate Limiter Service > should allow requests within rate limit
✓ Rate Limiter Service > should block requests exceeding rate limit [0.14ms]
✓ Rate Limiter Service > should track different identifiers separately [0.05ms]
✓ Rate Limiter Service > should use correct presets for login [0.02ms]
✓ Rate Limiter Service > should use correct presets for signup [0.02ms]
✓ Rate Limiter Service > should reset rate limits [0.08ms]

test/rate-limit.test.ts:
[2025-06-20T14:21:33.386Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.456Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":22}
[2025-06-20T14:21:33.456Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.527Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":22}
[2025-06-20T14:21:33.528Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.598Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":22}
[2025-06-20T14:21:33.598Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.668Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":22}
[2025-06-20T14:21:33.669Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.738Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":22}
✓ Rate Limiting > Login rate limiting > should allow login attempts within rate 
limit [353.81ms]
[2025-06-20T14:21:33.812Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.881Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":23}
[2025-06-20T14:21:33.881Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:33.951Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":23}
[2025-06-20T14:21:33.951Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.021Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":23}
[2025-06-20T14:21:34.022Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.092Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":23}
[2025-06-20T14:21:34.093Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.163Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":23}
[2025-06-20T14:21:34.163Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
✓ Rate Limiting > Login rate limiting > should block login attempts after exceed
ing rate limit [352.50ms]
[2025-06-20T14:21:34.309Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.380Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":24}
[2025-06-20T14:21:34.380Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.452Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":24}
[2025-06-20T14:21:34.452Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.525Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":24}
[2025-06-20T14:21:34.526Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.599Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":24}
[2025-06-20T14:21:34.599Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:34.671Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":24}
[2025-06-20T14:21:34.672Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"another@example.com"}
[2025-06-20T14:21:34.744Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"another@example.c
om","userId":25}
✓ Rate Limiting > Login rate limiting > should use email as identifier for rate 
limiting [508.20ms]
[2025-06-20T14:21:34.745Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser0@example.com"}
[2025-06-20T14:21:34.819Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":26,"email":"newuser0@e
xample.com"}
[2025-06-20T14:21:34.820Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser1@example.com"}
[2025-06-20T14:21:34.895Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":27,"email":"newuser1@e
xample.com"}
[2025-06-20T14:21:34.895Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser2@example.com"}
[2025-06-20T14:21:34.971Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":28,"email":"newuser2@e
xample.com"}
✓ Rate Limiting > Signup rate limiting > should allow signup attempts within rat
e limit [226.86ms]
[2025-06-20T14:21:34.972Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser@example.com"}
[2025-06-20T14:21:35.047Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":29,"email":"newuser@ex
ample.com"}
[2025-06-20T14:21:35.047Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser@example.com"}
[2025-06-20T14:21:35.048Z] [WARN] Signup failed - email already exists | {"servi
ce":"graphql-auth","environment":"test","resolver":"signup","email":"newuser@exa
mple.com"}
[2025-06-20T14:21:35.048Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser@example.com"}
[2025-06-20T14:21:35.048Z] [WARN] Signup failed - email already exists | {"servi
ce":"graphql-auth","environment":"test","resolver":"signup","email":"newuser@exa
mple.com"}
[2025-06-20T14:21:35.049Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"newuser@example.com"}
✓ Rate Limiting > Signup rate limiting > should block signup attempts after exce
eding rate limit [77.48ms]
[2025-06-20T14:21:35.049Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"testuser@example.com"}
[2025-06-20T14:21:35.124Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":30,"email":"testuser@e
xample.com"}
[2025-06-20T14:21:35.125Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"testuser@example.com"}
[2025-06-20T14:21:35.125Z] [WARN] Signup failed - email already exists | {"servi
ce":"graphql-auth","environment":"test","resolver":"signup","email":"testuser@ex
ample.com"}
[2025-06-20T14:21:35.126Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"testuser@example.com"}
[2025-06-20T14:21:35.126Z] [WARN] Signup failed - email already exists | {"servi
ce":"graphql-auth","environment":"test","resolver":"signup","email":"testuser@ex
ample.com"}
[2025-06-20T14:21:35.126Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"testuser@example.com"}
✓ Rate Limiting > Signup rate limiting > should track rate limits by normalized 
email [77.60ms]
[2025-06-20T14:21:35.200Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:35.270Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":31}
[2025-06-20T14:21:35.271Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:35.351Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":31}
[2025-06-20T14:21:35.351Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:35.422Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":31}
[2025-06-20T14:21:35.422Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:35.492Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":31}
[2025-06-20T14:21:35.493Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
[2025-06-20T14:21:35.562Z] [WARN] Login failed - invalid password | {"service":"
graphql-auth","environment":"test","resolver":"login","email":"ratelimit@example
.com","userId":31}
[2025-06-20T14:21:35.563Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"ratelimit@example.com"}
✓ Rate Limiting > Rate limit error response > should include retry information i
n rate limit error [363.42ms]

test/posts.test.ts:
✓ Posts > Query posts > should fetch all published posts in feed [2.99ms]
✓ Posts > Query posts > should fetch user drafts when authenticated [2.09ms]
✓ Posts > Query posts > should require authentication for drafts [0.16ms]
[2025-06-20T14:21:35.858Z] [INFO] Creating new post | {"service":"graphql-auth",
"environment":"test","resolver":"createPost","authorId":35,"title":"New Draft Po
st","published":false}
[2025-06-20T14:21:35.860Z] [INFO] Post created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"createPost","postId":15,"authorId":35,"
published":false}
✓ Posts > Create posts > should create a draft when authenticated [3.70ms]
✓ Posts > Create posts > should require authentication to create drafts [0.23ms]
[2025-06-20T14:21:36.008Z] [INFO] Deleting post | {"service":"graphql-auth","env
ironment":"test","resolver":"deletePost","postId":16,"userId":37}
[2025-06-20T14:21:36.008Z] [INFO] Post deleted successfully | {"service":"graphq
l-auth","environment":"test","resolver":"deletePost","postId":16}
✓ Posts > Delete posts > should allow owner to delete their post [3.77ms]
✓ Posts > Delete posts > should not allow deleting posts by other users [82.59ms
]
✓ Posts > Delete posts > should require authentication to delete posts [1.60ms]
[2025-06-20T14:21:36.318Z] [INFO] Incrementing post view count | {"service":"gra
phql-auth","environment":"test","resolver":"incrementPostViewCount","postId":19}
[2025-06-20T14:21:36.319Z] [INFO] Post view count incremented | {"service":"grap
hql-auth","environment":"test","resolver":"incrementPostViewCount","postId":19,"
newCount":1}
[2025-06-20T14:21:36.320Z] [INFO] Incrementing post view count | {"service":"gra
phql-auth","environment":"test","resolver":"incrementPostViewCount","postId":19}
[2025-06-20T14:21:36.321Z] [INFO] Post view count incremented | {"service":"grap
hql-auth","environment":"test","resolver":"incrementPostViewCount","postId":19,"
newCount":2}
✓ Posts > Increment view count > should increment post view count [5.91ms]
✓ Posts > Increment view count > should fail for non-existent post [0.67ms]

test/permissions.test.ts:
✓ Enhanced Permissions System > Permission Utilities > should correctly identify
 if user can access their own data
✓ Enhanced Permissions System > Permission Utilities > should deny access to oth
er users data for regular users [0.08ms]
✓ Enhanced Permissions System > Permission Utilities > should validate operation
s correctly [0.28ms]
✓ Enhanced Permissions System > Permission Utilities > should correctly check po
st modification permissions [1.40ms]
✓ Enhanced Permissions System > Permission Utilities > should handle role hierar
chy correctly [0.35ms]
✓ Enhanced Permissions System > GraphQL Permission Rules > should allow public a
ccess to feed query [3.88ms]
✓ Enhanced Permissions System > GraphQL Permission Rules > should require authen
tication for me query [2.33ms]
✓ Enhanced Permissions System > GraphQL Permission Rules > should enforce user o
wnership for drafts query [2.92ms]
✓ Enhanced Permissions System > GraphQL Permission Rules > should enforce post o
wnership for mutations [2.22ms]
✓ Enhanced Permissions System > GraphQL Permission Rules > should handle invalid
 post IDs gracefully [1.03ms]
[2025-06-20T14:21:37.987Z] [INFO] Signup attempt | {"service":"graphql-auth","en
vironment":"test","resolver":"signup","email":"ratelimit11@example.com"}
[2025-06-20T14:21:38.061Z] [INFO] User created successfully | {"service":"graphq
l-auth","environment":"test","resolver":"signup","userId":65,"email":"ratelimit1
1@example.com"}
✓ Enhanced Permissions System > Rate Limiting and Security > should apply rate l
imiting rules to signup [75.40ms]
[2025-06-20T14:21:38.203Z] [INFO] Login attempt | {"service":"graphql-auth","env
ironment":"test","resolver":"login","email":"nonexistent@example.com"}
[2025-06-20T14:21:38.204Z] [WARN] Login failed - user not found | {"service":"gr
aphql-auth","environment":"test","resolver":"login","email":"nonexistent@example
.com"}
✓ Enhanced Permissions System > Rate Limiting and Security > should allow public
 access to login [1.37ms]
✓ Enhanced Permissions System > Fallback Rules > should allow public access to p
ublished posts [2.84ms]

test/dataloader.test.ts:
✓ DataLoaders > userById loader > should batch load users by ID [13.29ms]
✓ DataLoaders > userById loader > should return null for non-existent users [0.8
2ms]
✓ DataLoaders > userById loader > should cache repeated requests [1.76ms]
✓ DataLoaders > postsByAuthorId loader > should batch load posts by author ID [4
.37ms]
✓ DataLoaders > postsByAuthorId loader > should return empty array for users wit
h no posts [1.49ms]
✓ DataLoaders > count loaders > should batch load published and draft post count
s [2.38ms]
✓ DataLoaders > count loaders > should batch load total views [2.60ms]
✓ DataLoaders > hasPostsByAuthor loader > should correctly identify users with a
nd without posts [3.17ms]
✓ DataLoaders > latestPostByAuthor loader > should load the most recent post for
 each author [2.98ms]
✓ DataLoaders > latestPostByAuthor loader > should return null for users with no
 posts [1.37ms]

 70 pass
 0 fail
 169 expect() calls
Ran 70 tests across 9 files. [10.07s]

```

---



---

Tests passed. `RateLimiterService.resetAll()` called in `test/setup.ts` fixed the rate limiter state leak between test files.

---



---



---

Tests fixed. I'll inform the user now. I resolved a rate limiter state persistence issue by adding a reset mechanism that runs after each test file.

---

